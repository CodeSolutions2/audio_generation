<!DOCTYPE html>
<html>
<head></head>
<body>


<label for="select_dropdown_option_label">Select a choice:</label>
<select name="dropdown_options" id="dropdown_options" style="display:block">
  <option value="---">Select an option</option>
  <option value="make_blank_canvas">make_blank_canvas</option>
  <option value="color_the_canvas">color_the_canvas</option>
  <option value="check_if_canvas_is_filled">check_if_canvas_is_filled</option>
  <option value="resize">resize</option>
</select>


<input type="text" name="width_NEW" id="width_NEW" value="" style="display:none;">
<input type="text" name="height_NEW" id="height_NEW" value="" style="display:none;">

<button id="run_selection" onclick="run_selection()">run_selection</button>


<div id="data_display" style="display:block; text-align: left; width: 600px;"></div>
<br>
<div id="notification"></div>


<!-- ---------------------------------------- -->
	
<style>
div#notification { position: relative; color: #3236a8; }
</style>

<!-- ---------------------------------------- -->
	
<script>


// -------------------------------------------------

window.addEventListener('beforeunload', function() {
	window.location.href = window.location.href + '?nocache=' + new Date().getTime();
	document.getElementById("dropdown_options").selectedIndex = 0;
});

// -------------------------------------------------
	
async function processEvent_dropdown_options(event) {
	
	if (document.getElementById("dropdown_options").selectedIndex == 4) {
		document.getElementById("width_NEW").style.display = 'block';
		document.getElementById("height_NEW").style.display = 'block';
		
	} else {
		document.getElementById("width_NEW").style.display = 'none';
		document.getElementById("height_NEW").style.display = 'none';
	}
	
}

document.getElementById("dropdown_options").addEventListener("change", processEvent_dropdown_options, false);
	
// -------------------------------------------------

async function run_selection() {
	
	// Put in a function in <script>
	var dropdown_option_type = document.getElementById("dropdown_options").value;

	if (dropdown_option_type == 'make_blank_canvas') {
		await make_blank_canvas();
		
	} else if (dropdown_option_type == 'color_the_canvas') {
		await color_the_canvas();

	} else if (dropdown_option_type == 'check_if_canvas_is_filled') {
		await check_if_canvas_is_filled();

	} else if (dropdown_option_type == 'resize') {
		await resize();
		
	} else {
		document.getElementById("notification") = "No dropdown type selected";
	}


}

// -------------------------------------------------

  var canvasElement;
  var ctx;

   var width_ORG = 256;
  var height_ORG = 256;

// -------------------------------------------------

async function make_blank_canvas() {

// -------------------------
  // Create a canvas element
	canvasElement = document.createElement('canvas');

	// Set attributes of the canvas
	canvasElement.width = width_ORG;
	canvasElement.height = height_ORG;
  	canvasElement.id = "canvasElement_id";
	canvasElement.class = "canvasElement_className";
	
	// Get the 2D rendering context of the canvas
	ctx = canvasElement.getContext("2d");
  
  // Add the canvas to the DOM
	document.getElementById('data_display').appendChild(canvasElement);

  // -------------------------
  
  // Make a canvas border
	document.getElementById('canvasElement_id').style.border = '1px solid black';

  // -------------------------
  
  // Color the canvas
  // await color_the_canvas();
  
  // OR

  // Leave the canvas blank

  // -------------------------

}


async function color_the_canvas() {
  // -------------------------
  // Color the canvas
  var r = Math.floor(Math.random()*255);
	var g = Math.floor(Math.random()*255);
  	var b = Math.floor(Math.random()*255);
  	const alpha = Math.floor(Math.random()*100);
  
  	// ----------------------
  
  	// Make r, g, b and interesting color range.
	// Make r from 1 to 255 if r>1, then output=r else output=1
	r = r>0 ? r : 1;
	g = g>0 ? g : 1;
	b = b>0 ? b : 1;

	// ----------------------
	
	ctx.fillStyle = `rgb(${r} ${g} ${b} / ${alpha}%)`;
	ctx.fillRect(0, 0, canvasElement.width, canvasElement.height);
}


  
  
async function check_if_canvas_is_filled() {
	
	// Get canvas image
	const uint8ClampedArray = await ctx.getImageData(0, 0, canvasElement.width, canvasElement.height); // TypedArray  Uint8ClampedArray
	// console.log('uint8ClampedArray: ', uint8ClampedArray);
  
	// Convert TypedArray to normalArray
	var normalArray = await Array.from(uint8ClampedArray.data);

	// ----------------------
	
	// A blank canvas has rgb values that are zero.
	// Modify some of the pixels, to determine if there is a change
	const color_name = ['r', 'g', 'b', 'alpha'];
	var r_sum = 0;
	var g_sum = 0;
	var b_sum = 0;
	for ( let i=0; i<normalArray.length; i+=color_name.length ) {
		r_sum = r_sum + normalArray[i];
		g_sum = g_sum + normalArray[i+1];
		b_sum = b_sum + normalArray[i+2];
	}
	console.log("r_sum: ", r_sum);
	console.log("g_sum: ", g_sum);
	console.log("b_sum: ", b_sum);
	var result0 = (r_sum + g_sum + b_sum) == 0 ? 'blank' : 'filled';
	console.log("result0: ", result0);

	// OR

	var result_arr = normalArray.map((val, ind) => {
		if (val != 0) {
			return 'filled';
		} else {
			return '';
		}
	}).filter((x) => x.length != 0);
	console.log("result_arr: ", result_arr);

	var result1 = result_arr.length == 0 ? 'blank' : 'filled';
	console.log("result1: ", result1);

	// ----------------------

  	return result0;
}


async function resize() {
	
	// Check if canvas is filled
	var result = await check_if_canvas_is_filled();
	console.log("result: ", result);

	// If not filled, notation to draw on canvas
	if (result == "filled") {

		// Way 0: resize the existing canvas and maybe the image will be automatically resized
		// canvasElement.width = document.getElementById("width_NEW").value;
		// canvasElement.height = document.getElementById("height_NEW").value;
		// RESULT: a resized blank canvas is only shown

		// Way 1: make ImageData like that of FileReader (base64string) - then blob - url
		// Put the ASCII_str on a URL
		// make the canvas an ASCII_str
		// const [ASCII_str, base64_string] = await convert_canvas_to_base64str(ctx, canvasElement)
		// maybe put image string before
		// await fetch(base64_string)
		// 	.then(response => response.blob())
		// 	.then(async function(blob_object) {
				// resize the existing canvas
				// canvasElement.width = document.getElementById("width_NEW").value;
				// canvasElement.height = document.getElementById("height_NEW").value;

				// console.log('blob_object: ', blob_object)
				// document.getElementById("canvasElement_id").src = URL.createObjectURL(blob_object);
			// });
		// RESULT: a resized blank canvas is only shown


		
		// Way 2: use canvas ImageData
		// Get existing canvas image
		// const uint8ClampedArray = await ctx.getImageData(0, 0, canvasElement.width, canvasElement.height);
		// console.log('uint8ClampedArray: ', uint8ClampedArray);


		
		// Way 3 : make a new image object with old image from canvasElement, draw image on the canvas with a different width and height
		// Re-define how to draw the image on teh canvas
		var sx = 0; // for cropping the image: distance from the [original left edge of the image] to the [deisred left edge of image]
		var sy = 0; // for cropping the image: distance from the [original top edge of the image] to the [deisred top edge of image]
		var image_width = canvasElement.width; // for cropping the image: desired image width
		var image_height = canvasElement.height; // for cropping the image: desired image height
		var dx = 0;  // location to place image on canvas: distance from the [left edge of the canvas] to the [left edge of image]
		var dy = 0;  // location to place image on canvas: distance from the [top edge of the canvas] to the [top edge of image]
		var dWidth = document.getElementById("width_NEW").value; // for resizing the image on the canvas: desired image width on canvas
		var dHeight = document.getElementById("width_NEW").value; // for resizing the image on the canvas: desired image width on canvas

		
		canvasElement.width = dWidth;
		canvasElement.height = dHeight;
		
		const image = new Image();
		image.crossOrigin = "anonymous";
		image.onload = async () => {
		         ctx.drawImage(image, sx, sy, image_width, image_height, dx, dy, dWidth, dHeight)
		};
		image.src = document.getElementById("canvasElement_id").src;

		// Putting this after shows an empty resized canvas
		// canvasElement.width = dWidth;
		// canvasElement.height = dHeight;
		

	} else {
		document.getElementById("notification") = "fill the blank canvas before resizing"
	}
  
}
  
// -------------------------------------------------

async function convert_canvas_to_base64str(ctx, canvasElement) {
	
	// -----------------------------
	
	// Get canvas image
	const uint8ClampedArray = await ctx.getImageData(0, 0, canvasElement.width, canvasElement.height); // TypedArray  Uint8ClampedArray
	// console.log('uint8ClampedArray: ', uint8ClampedArray);

	// Convert TypedArray to normalArray
	const normalArray = await Array.from(uint8ClampedArray.data);
	// console.log('normalArray: ', normalArray);
	
	// Convert [normalArray of bytes] to text_characters
	var ASCII_stringArray = normalArray.map((val) => { return String.fromCharCode(val); });
	// console.log('ASCII_stringArray: ', ASCII_stringArray);
	
	// Join all the ASCII characters to form a string
	var ASCII_str = ASCII_stringArray.join('');
	// console.log("ASCII_str: ", ASCII_str);
	
	// Transform ASCII string into a base64 string
	var base64_string = btoa(ASCII_str);
	// console.log("base64_string: ", base64_string);

	// -----------------------------

	return [ASCII_str, base64_string];
}
	
// -------------------------------------------------
	
</script>
</body>
</html>
